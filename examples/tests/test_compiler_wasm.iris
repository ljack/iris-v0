;; Test fixture: compile Iris source to WebAssembly.
;; Uses compiler modules from examples/real/compiler.
(program
  (module (name "test_compiler_wasm") (version 1))
  (imports
    (import "io" (as "io"))
    (import "../real/compiler/compiler_lib" (as "compiler"))
  )
  (defs
    (deffn (name main) (args) (ret I64) (eff !IO)
        (doc "Compile a wasm syntax fixture and write output.wat.")
        (body
            (let (res (call compiler.compile_file "examples/tests/test_wasm_syntax.iris" "wasm"))
                (match res
                    (case (tag "Ok" (wat))
                        (let (_ (io.write_file "output.wat" wat)) 0)
                    )
                    (case (tag "Err" (msg))
                        (let (_ (io.print msg)) 1)
                    )
                )
            )
        )
    )
  )
)
