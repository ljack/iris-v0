;; Sandbox: scratchpad for local experiments.
;; Not part of the core examples or tests.
(program
  (module (name "compiler") (version 1))
  (imports
    (import "sys" (as "sys"))
    (import "io" (as "io"))
    (import "str" (as "str"))
    (import "list" (as "list"))
    (import "../real/compiler/lexer" (as "lexer"))
    (import "../real/compiler/parser" (as "parser"))
    (import "../real/compiler/typecheck" (as "typecheck"))
    (import "../real/compiler/codegen" (as "codegen"))
    (import "../real/compiler/codegen_wasm" (as "codegen_wasm"))
  )
  (defs
 
  (deffn (name compile_file) (args (path Str) (target Str)) (ret (Result Str Str)) (eff !IO)
        (doc "Compile a file to the requested target (core or wasm).")
        (body
            (let (read_res (io.read_file path))
                (match read_res
                    (case (tag "Err" (msg)) (tag "Err" (str.concat "File error: " msg)))
                    (case (tag "Ok" (source))
                        ;; 1. Tokenize
                        (let (tokens (lexer.tokenize source))
                            ;; 2. Parse
                            (let (ast (parser.parse tokens))
                                ;; 3. Type Check
                                (let (tc_res (typecheck.type_check_program ast))
                                        (match tc_res
                                            (case (tag "Err" (msg)) (tag "Err" (str.concat "Type Check Error: " msg)))
                                            (case (tag "Ok" (ignore))
                                                (if (str.contains target "wasm")
                                                    (tag "Ok" (codegen_wasm.codegen_module ast))
                                                    (tag "Ok" (codegen.codegen ast))
                                                )
                                            )
                                        )
                                    )
                                )
                            )
                        )
                    )
                )
            )
        )
    
    
    (deffn (name main) (args) (ret I64) (eff !IO)
        (doc "CLI wrapper around compile_file for sandbox testing.")
        (body
            (let (args (sys.args))
                (if (< (list.length args) 1)
                    (let (_ (io.print "Usage: compile_file <file> [target]")) 1)
                    (let (file_opt (list.get args 0))
                        (match file_opt
                            (case (tag "None") 1)
                            (case (tag "Some" (file))
                                (let (target_opt (list.get args 1))
                                    (let (target (match target_opt (case (tag "Some" (t)) t) (case (tag "None") "wasm")))
                                        (let (res (compile_file file target))
                                            (match res
                                                (case (tag "Ok" (out)) (let (_ (io.print out)) 0))
                                                (case (tag "Err" (msg)) (let (_ (io.print msg)) 1))
                                            )
                                        )
                                    )
                                )
                            )
                        )
                    )
                )
            )
        )
    )
  )
)
