;; Compiler module: CLI entrypoint for compiling Iris files.
;; Part of the Iris compiler pipeline in examples/real/compiler.
(program
  (module (name "compiler") (version 1))
  (imports
    (import "sys" (as "sys"))
    (import "io" (as "io"))
    (import "list" (as "list"))
    (import "compiler_lib" (as "clib"))
  )
  (defs
    (deffn (name main) (args) (ret Str) (eff !IO)
        (doc "CLI wrapper around compiler_lib.compile_file.")
        (body
            (let (args (sys.args))
                (if (< (list.length args) 1)
                    "Usage: compile_file <file> [target]"
                    (let (file_opt (list.get args 0))
                        (match file_opt
                            (case (tag "None") "Usage: compile_file <file> [target]")
                            (case (tag "Some" (file))
                                (let (target_opt (list.get args 1))
                                    (let (target (match target_opt (case (tag "Some" (t)) t) (case (tag "None") "wasm")))
                                        (let (res (clib.compile_file file target))
                                            (match res
                                                (case (tag "Ok" (out)) out)
                                                (case (tag "Err" (msg)) msg)
                                            )
                                        )
                                    )
                                )
                            )
                        )
                    )
                )
            )
        )
    )
  )
)
